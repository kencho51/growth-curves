<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Growth Chart Plotter - WHO/CDC & Hong Kong Standards</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        
        .input-section {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: end;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }
        
        label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }
        
        input, select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            height: fit-content;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        .chart-container {
            position: relative;
            height: 600px;
            margin-top: 20px;
        }
        
        .info-box {
            background-color: #e8f5e8;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            border-left: 4px solid #4CAF50;
        }
        
        .error {
            background-color: #ffebee;
            border-left-color: #f44336;
            color: #c62828;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            justify-content: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 20px;
            height: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Growth Chart Plotter</h1>
        <p style="text-align: center; color: #666; margin-top: -15px; margin-bottom: 30px;">Choose between WHO/CDC International or Hong Kong 2020 growth standards</p>
        
        <div class="input-section">
            <div class="input-group">
                <label for="standard">Growth Standard:</label>
                <select id="standard">
                    <option value="who_cdc">WHO/CDC International</option>
                    <option value="hk2020">Hong Kong 2020</option>
                </select>
            </div>
            
            <div class="input-group">
                <label for="gender">Gender:</label>
                <select id="gender">
                    <option value="boy">Boy</option>
                    <option value="girl">Girl</option>
                </select>
            </div>
            
            <div class="input-group">
                <label for="age">Age (years):</label>
                <input type="number" id="age" min="0" max="18" step="0.1" placeholder="0-18">
            </div>
            
            <div class="input-group">
                <label for="height">Height (cm):</label>
                <input type="number" id="height" min="30" max="200" step="0.1" placeholder="30-200">
            </div>
            
            <button onclick="plotPoint()">Plot on Chart</button>
        </div>
        
        <div class="chart-container">
            <canvas id="growthChart"></canvas>
        </div>
        
        <div id="info" class="info-box" style="display: none;"></div>
        
        <div id="legend" class="legend">
            <!-- Legend will be populated dynamically -->
        </div>
        
        <div class="info-section" style="margin-top: 30px; padding: 20px; background-color: #f8f9fa; border-radius: 5px; font-size: 14px;">
            <h3 style="margin-top: 0; color: #555;">Data Sources</h3>
            <p><strong>WHO/CDC International:</strong> Based on the WHO Child Growth Standards (2006) developed from the WHO Multicentre Growth Reference Study (1997-2003) conducted in 6 countries (Brazil, Ghana, India, Norway, Oman, USA). Represents optimal growth under ideal health conditions.</p>
            <p><strong>Hong Kong 2020:</strong> Based on the Hong Kong Growth Survey 2020-22 conducted by Chinese University of Hong Kong and University of Hong Kong. Represents growth patterns of contemporary Hong Kong children of Chinese ethnicity.</p>
            <p><em>Note: This is a tool for reference only. Always consult healthcare professionals for proper growth assessment and medical advice.</em></p>
        </div>
    </div>

    <script>
        let chart;
        let userDataPoint = null;

        // Growth chart data from multiple standards
        // Note: Internal data is stored in months, but displayed as years on the chart
        
        // Sources:
        // WHO/CDC: WHO Child Growth Standards (2006) based on Multicentre Growth Reference Study
        //          Source: https://www.who.int/tools/child-growth-standards
        // HK2020: Hong Kong Growth Survey 2020-22, Chinese University of Hong Kong
        //         Source: https://www.cuhk.edu.hk/proj/hkgrowth/
        
        const growthData = {
            who_cdc: {
                boy: {
                    // Ages in months: 0, 3, 6, 12, 18, 24, 36, 48, 60, 72, 96, 120, 144, 168, 192, 216
                    // Equivalent years: 0, 0.25, 0.5, 1, 1.5, 2, 3, 4, 5, 6, 8, 10, 12, 14, 16, 18
                    ages: [0, 3, 6, 12, 18, 24, 36, 48, 60, 72, 96, 120, 144, 168, 192, 216],
                    percentiles: {
                        p3: [46.1, 57.3, 63.3, 71.0, 76.9, 81.7, 88.7, 94.9, 100.7, 106.1, 116.6, 126.6, 136.2, 145.4, 154.6, 163.2],
                        p10: [47.5, 59.0, 65.1, 73.2, 79.2, 84.1, 91.2, 97.6, 103.5, 109.0, 119.8, 130.0, 139.9, 149.3, 158.7, 167.5],
                        p25: [49.0, 60.8, 66.8, 75.1, 81.2, 86.2, 93.5, 100.0, 106.1, 111.7, 122.8, 133.0, 143.0, 152.6, 162.2, 171.2],
                        p50: [50.0, 62.1, 68.0, 76.1, 82.3, 87.1, 94.9, 101.6, 107.7, 113.5, 124.8, 135.4, 145.6, 155.4, 165.3, 174.5],
                        p75: [51.8, 64.4, 70.2, 78.8, 85.1, 90.0, 98.0, 104.9, 111.0, 116.9, 128.4, 139.0, 149.3, 159.4, 169.6, 179.0],
                        p90: [53.4, 66.1, 71.9, 80.8, 87.2, 92.2, 100.3, 107.5, 113.6, 119.6, 131.4, 142.0, 152.3, 162.7, 173.2, 182.9],
                        p97: [55.0, 67.8, 73.5, 82.5, 89.0, 94.1, 102.3, 109.7, 115.9, 121.9, 134.0, 144.7, 155.0, 165.7, 176.5, 186.4]
                    }
                },
                girl: {
                    ages: [0, 3, 6, 12, 18, 24, 36, 48, 60, 72, 96, 120, 144, 168, 192, 216],
                    percentiles: {
                        p3: [45.4, 56.1, 61.8, 68.9, 74.9, 79.3, 86.0, 92.0, 97.7, 103.0, 113.5, 123.5, 133.5, 143.8, 152.8, 158.7],
                        p10: [46.8, 57.8, 63.5, 70.8, 76.8, 81.3, 88.1, 94.1, 99.9, 105.3, 115.9, 126.0, 136.2, 146.7, 155.8, 161.8],
                        p25: [48.2, 59.5, 65.2, 72.8, 78.8, 83.4, 90.3, 96.4, 102.3, 107.8, 118.7, 128.8, 139.2, 149.8, 159.0, 165.1],
                        p50: [49.1, 60.9, 66.6, 74.0, 80.0, 84.6, 91.7, 97.9, 103.9, 109.4, 120.6, 130.9, 141.5, 152.3, 161.8, 168.1],
                        p75: [50.9, 63.2, 68.8, 76.8, 82.8, 87.4, 94.6, 100.9, 106.9, 112.5, 124.0, 134.4, 145.2, 156.3, 166.0, 172.4],
                        p90: [52.0, 64.7, 70.3, 78.4, 84.7, 89.4, 96.9, 103.3, 109.4, 115.1, 126.9, 137.4, 148.4, 159.8, 169.8, 176.2],
                        p97: [53.7, 66.5, 72.1, 80.1, 86.5, 91.3, 98.9, 105.4, 111.7, 117.4, 129.5, 140.2, 151.4, 163.0, 173.4, 179.8]
                    }
                }
            },
            hk2020: {
                boy: {
                    // Hong Kong 2020 Growth Survey 2020-22 - Real data from official CSV
                    // Source: HK-2020-StandardTables_v2.csv
                    ages: [0, 3, 6, 12, 18, 24, 36, 48, 60, 72, 96, 120, 144, 168, 192, 216],
                    percentiles: {
                        p0_4: [45.51, 56.14, 62.09, 69.12, 74.89, 79.29, 85.69, 91.98, 97.28, 102.56, 113.21, 124.19, 133.71, 144.82, 155.73, 155.73], // 0.4th percentile
                        p2: [46.51, 57.54, 65.65, 70.7, 75.36, 81.16, 86.04, 93.39, 99.04, 105.61, 115.77, 130.91, 137.65, 147.65, 159.05, 160.05], // 2nd percentile
                        p9: [47.54, 58.67, 65.65, 73.38, 79.36, 84.2, 90.09, 96.98, 102.87, 108.71, 119.77, 130.91, 143.39, 154.65, 164.28, 164.28], // 9th percentile
                        p25: [48.58, 59.98, 66.89, 75.08, 81.07, 86.13, 92.4, 99.58, 105.76, 111.87, 124.8, 137.36, 148.16, 159.33, 168.35, 168.44], // 25th percentile
                        p50: [49.65, 61.31, 68.88, 76.1, 82.2, 87.22, 94.78, 102.26, 108.7, 115.09, 127.8, 141.89, 152.88, 163.87, 172.46, 172.53], // 50th percentile
                        p75: [50.73, 62.68, 70.41, 78.17, 84.17, 89.37, 97.23, 105.01, 111.71, 118.36, 131.4, 146.48, 157.55, 168.95, 176.54, 176.54], // 75th percentile
                        p91: [51.84, 64.07, 70.98, 80.47, 86.2, 91.58, 99.77, 107.84, 114.79, 121.68, 135.58, 151.14, 162.18, 174.83, 180.5, 180.5], // 91st percentile
                        p98: [52.97, 65.5, 72.59, 82.37, 88.29, 93.87, 102.39, 110.74, 117.93, 125.07, 139.61, 155.86, 166.78, 180.92, 184.39, 184.39], // 98th percentile
                        p99_6: [54.13, 66.95, 74.24, 84.33, 90.45, 96.23, 105.1, 113.72, 121.13, 128.51, 143.72, 160.64, 171.33, 186.41, 188.22, 188.22] // 99.6th percentile
                    }
                },
                girl: {
                    // Hong Kong 2020 Growth Survey 2020-22 - Real data from official CSV
                    ages: [0, 3, 6, 12, 18, 24, 36, 48, 60, 72, 96, 120, 144, 168, 192, 216],
                    percentiles: {
                        p0_4: [44.98, 54.87, 60.73, 67.41, 73.05, 77.55, 83.07, 89.62, 95.03, 99.78, 110.26, 118.0, 129.89, 135.19, 140.39, 145.92], // 0.4th percentile
                        p2: [45.95, 56.07, 62.06, 69.99, 75.56, 80.02, 85.7, 92.94, 98.58, 105.39, 116.03, 127.57, 134.04, 139.54, 144.62, 149.42], // 2nd percentile
                        p9: [46.93, 57.28, 63.42, 70.44, 75.68, 80.02, 86.39, 93.09, 99.09, 105.35, 116.67, 128.3, 141.37, 151.38, 152.92, 152.96], // 9th percentile
                        p25: [47.92, 58.5, 64.78, 72.23, 77.71, 82.19, 88.7, 95.37, 101.61, 108.21, 120, 132.83, 145.81, 154.67, 156.54, 156.54], // 25th percentile
                        p50: [48.92, 59.73, 66.17, 73.73, 79.32, 84.19, 91.02, 97.77, 104.32, 111.12, 123.41, 137.77, 150.32, 158.58, 160.18, 160.16], // 50th percentile
                        p75: [49.92, 60.98, 67.57, 75.56, 81.66, 86.91, 94.32, 100.3, 107.02, 114.08, 126.9, 142.66, 154.9, 162.45, 163.84, 163.82], // 75th percentile
                        p91: [50.93, 62.24, 68.99, 77.23, 83.41, 88.91, 96.61, 102.83, 109.78, 117.09, 130.48, 147.58, 159.56, 166.29, 167.52, 167.52], // 91st percentile
                        p98: [51.95, 63.51, 70.43, 79.71, 86.37, 92.73, 100.46, 107.18, 115.16, 123.28, 137.63, 157.33, 169.11, 173.85, 175.04, 175.04], // 98th percentile
                        p99_6: [52.98, 64.8, 71.89, 81.43, 88.3, 94.91, 102.92, 110.06, 118.19, 127.04, 141.59, 162.21, 175.7, 181.47, 182.41, 182.41] // 99.6th percentile
                    }
                }
            }
        };

        function initChart() {
            const ctx = document.getElementById('growthChart').getContext('2d');
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: 'Age (years)'
                            },
                            min: 0,
                            max: 18
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Height (cm)'
                            },
                            min: 40,
                            max: 200
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'point',
                            intersect: false
                        }
                    },
                    elements: {
                        point: {
                            radius: 0,
                            hoverRadius: 5
                        }
                    }
                }
            });
            
            updateChart();
        }

        function updateLegend() {
            const standard = document.getElementById('standard').value;
            const legendDiv = document.getElementById('legend');
            
            const legendData = standard === 'who_cdc' ? {
                'p3': { color: '#ff6b6b', label: '3rd Percentile' },
                'p10': { color: '#feca57', label: '10th Percentile' },
                'p25': { color: '#48dbfb', label: '25th Percentile' },
                'p50': { color: '#0abde3', label: '50th Percentile (Median)' },
                'p75': { color: '#48dbfb', label: '75th Percentile' },
                'p90': { color: '#feca57', label: '90th Percentile' },
                'p97': { color: '#ff6b6b', label: '97th Percentile' }
            } : {
                'p0_4': { color: '#d63031', label: '0.4th Percentile' },
                'p2': { color: '#e17055', label: '2nd Percentile' },
                'p9': { color: '#fdcb6e', label: '9th Percentile' },
                'p25': { color: '#74b9ff', label: '25th Percentile' },
                'p50': { color: '#0984e3', label: '50th Percentile (Median)' },
                'p75': { color: '#6c5ce7', label: '75th Percentile' },
                'p91': { color: '#a29bfe', label: '91st Percentile' },
                'p98': { color: '#fd79a8', label: '98th Percentile' },
                'p99_6': { color: '#e84393', label: '99.6th Percentile' }
            };
            
            legendDiv.innerHTML = '';
            Object.entries(legendData).forEach(([key, data]) => {
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.innerHTML = `
                    <div class="legend-color" style="background-color: ${data.color};"></div>
                    <span>${data.label}</span>
                `;
                legendDiv.appendChild(legendItem);
            });
        }

        function updateChart() {
            const standard = document.getElementById('standard').value;
            const gender = document.getElementById('gender').value;
            const data = growthData[standard][gender];
            
            const colors = standard === 'who_cdc' ? {
                p3: '#ff6b6b',
                p10: '#feca57',
                p25: '#48dbfb',
                p50: '#0abde3',
                p75: '#48dbfb',
                p90: '#feca57',
                p97: '#ff6b6b'
            } : {
                p0_4: '#d63031',
                p2: '#e17055',
                p9: '#fdcb6e',
                p25: '#74b9ff',
                p50: '#0984e3',
                p75: '#6c5ce7',
                p91: '#a29bfe',
                p98: '#fd79a8',
                p99_6: '#e84393'
            };

            chart.data.datasets = [];
            
            // Add percentile lines
            Object.keys(data.percentiles).forEach(percentile => {
                const percentileData = data.ages.map((age, index) => ({
                    x: age / 12, // Convert months to years for display
                    y: data.percentiles[percentile][index]
                }));
                
                let label = percentile.replace('p', '').replace('_', '.') + 'th Percentile';
                if (percentile === 'p50') label += ' (Median)';
                
                chart.data.datasets.push({
                    label: label,
                    data: percentileData,
                    borderColor: colors[percentile],
                    backgroundColor: colors[percentile],
                    borderWidth: percentile === 'p50' ? 3 : 2,
                    fill: false,
                    tension: 0.4
                });
            });
            
            // Add user data point if exists (ensure it's on top)
            if (userDataPoint) {
                chart.data.datasets.push({
                    label: 'Your Child',
                    data: [userDataPoint],
                    backgroundColor: '#ff3838',
                    borderColor: '#ff3838',
                    borderWidth: 3,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointStyle: 'cross',
                    pointRotation: 45,
                    showLine: false,
                    order: -1, // Ensures this dataset is rendered on top
                    zIndex: 1000 // Additional z-index for visibility
                });
            }
            
            updateLegend();
            chart.update();
        }

        function plotPoint() {
            const standard = document.getElementById('standard').value;
            const gender = document.getElementById('gender').value;
            const ageYears = parseFloat(document.getElementById('age').value);
            const height = parseFloat(document.getElementById('height').value);
            const infoDiv = document.getElementById('info');
            
            // Validation
            if (isNaN(ageYears) || isNaN(height)) {
                showInfo('Please enter valid numbers for age and height.', 'error');
                return;
            }
            
            if (ageYears < 0 || ageYears > 18) {
                showInfo('Age must be between 0 and 18 years.', 'error');
                return;
            }
            
            if (height < 30 || height > 200) {
                showInfo('Height must be between 30 and 200 cm.', 'error');
                return;
            }
            
            // Convert years to months for calculations
            const ageMonths = ageYears * 12;
            
            // Create user data point (display in years)
            userDataPoint = { x: ageYears, y: height };
            
            // Calculate percentile (using months)
            const percentile = calculatePercentile(standard, gender, ageMonths, height);
            
            // Update chart
            updateChart();
            
            // Show info
            const standardName = standard === 'who_cdc' ? 'WHO/CDC' : 'Hong Kong 2020';
            showInfo(`Plotted: ${gender === 'boy' ? 'Boy' : 'Girl'}, ${ageYears} years old, ${height} cm tall. Approximately ${percentile} percentile (${standardName} standard).`);
        }

        function calculatePercentile(standard, gender, ageMonths, height) {
            const data = growthData[standard][gender];
            
            // Find the closest age points for interpolation
            let lowerIndex = 0;
            let upperIndex = data.ages.length - 1;
            
            for (let i = 0; i < data.ages.length - 1; i++) {
                if (ageMonths >= data.ages[i] && ageMonths <= data.ages[i + 1]) {
                    lowerIndex = i;
                    upperIndex = i + 1;
                    break;
                }
            }
            
            // Interpolate percentile values for the given age
            const ageFactor = upperIndex === lowerIndex ? 0 : (ageMonths - data.ages[lowerIndex]) / (data.ages[upperIndex] - data.ages[lowerIndex]);
            
            // Different percentile structures for different standards
            const percentiles = standard === 'who_cdc' 
                ? ['p3', 'p10', 'p25', 'p50', 'p75', 'p90', 'p97']
                : ['p0_4', 'p2', 'p9', 'p25', 'p50', 'p75', 'p91', 'p98', 'p99_6'];
            
            const percentileValues = standard === 'who_cdc'
                ? [3, 10, 25, 50, 75, 90, 97]
                : [0.4, 2, 9, 25, 50, 75, 91, 98, 99.6];
            
            for (let i = 0; i < percentiles.length; i++) {
                const lowerHeight = data.percentiles[percentiles[i]][lowerIndex];
                const upperHeight = data.percentiles[percentiles[i]][upperIndex];
                const interpolatedHeight = lowerHeight + ageFactor * (upperHeight - lowerHeight);
                
                if (height <= interpolatedHeight) {
                    if (i === 0) return `<${percentileValues[i]}th`;
                    
                    // Interpolate between this and previous percentile
                    const prevPercentile = percentiles[i - 1];
                    const prevLowerHeight = data.percentiles[prevPercentile][lowerIndex];
                    const prevUpperHeight = data.percentiles[prevPercentile][upperIndex];
                    const prevInterpolatedHeight = prevLowerHeight + ageFactor * (prevUpperHeight - prevLowerHeight);
                    
                    const heightFactor = (height - prevInterpolatedHeight) / (interpolatedHeight - prevInterpolatedHeight);
                    const estimatedPercentile = percentileValues[i - 1] + heightFactor * (percentileValues[i] - percentileValues[i - 1]);
                    
                    return `${Math.round(estimatedPercentile * 10) / 10}th`;
                }
            }
            
            return standard === 'who_cdc' ? '>97th' : '>99.6th';
        }

        function showInfo(message, type = 'info') {
            const infoDiv = document.getElementById('info');
            infoDiv.textContent = message;
            infoDiv.className = 'info-box' + (type === 'error' ? ' error' : '');
            infoDiv.style.display = 'block';
        }

        // Initialize chart when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            updateLegend(); // Set initial legend
            
            // Update chart when standard or gender changes
            document.getElementById('standard').addEventListener('change', updateChart);
            document.getElementById('gender').addEventListener('change', updateChart);
        });
    </script>
</body>
</html> 